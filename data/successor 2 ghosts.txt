# Copyright (c) 2025 by Daeridanii
#
# Endless Sky is free software: you can redistribute it and/or modify it under the
# terms of the GNU General Public License as published by the Free Software
# Foundation, either version 3 of the License, or (at your option) any later version.
#
# Endless Sky is distributed in the hope that it will be useful, but WITHOUT ANY
# WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
# PARTICULAR PURPOSE. See the GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License along with
# this program. If not, see <https://www.gnu.org/licenses/>.

mission "Successors: Ghosts 0 Incident"
	landing
	invisible
	source
		attributes "successor"
		not attributes "quiet" "uninhabited"
	to offer
		has "trusted by the successors"
		date 9 25
	on offer
		event "successors: ghosts incident"
		event "successors: ghosts stage 1" 26
		log "Learned of an incident on a moon controlled by House Kaatrij that revealed portions of a hidden base."
		conversation
			`The usual orderly structure of the spaceport's activity lies in pieces. Throngs of merchants, travelers, and military officers alike crowd around displays in the port, their shops and vessels left behind. It is uncomfortably quiet - the only voice you hear above a whisper is that of a news announcer, writhing in your ears as the translation device rearranges the sound, word by word.`
			`	"... incident has laid bare aught what noble House Kaatrij hath labor'd t'leave concealed. The moon, long though lifeless, barren, raw, now show'th the spill-ed guts of some long-conceal'd base. View, fellows! See it seethe beneath the light!"`
			`	The display changes to show an overhead view of a sandy moon. Tucked in a valley between ochre dunes is a bloom of distorted metal and intermittent light, the shape of a long arc stretching for maybe a kilometer across the surface. Near the ends, the image shimmers and warps before the whole thing is obscured by a Kaatrij warship flying into view - it's not clear whether the distortion is actually present or just a fault of the transmission.`
			branch "seen this before"
				has "event: war begins"
			label continue
			`	Whatever the cause, it's clear that House Kaatrij has been caught out.`
				decline
			label "seen this before"
			`	The similarities to the immediate aftermath of the bombing of Geminus and Martini are striking. Though it's unclear what - or who - caused this incident, this could easily incite even greater conflict between the Houses.`
				goto continue



mission "Successors: Ghosts 0a1 QSI"
	# Note the naming convention: "Successors: Ghosts" is the narrative arc. "0" represents the stage of the arc. "a" represents a branch occuring at that specific stage. "1" represents the mission number in that specific branch. "QSI" is a one-word abbreviation of what's going on in the mission, to make the missions more identifiable.
	landing
	invisible
	source "Qasa-Sija-Iri"
	to offer
		has "successors: ghosts stage 0"
		not "successors: ghosts restriction lifted"
	on offer
		conversation
			`Immediately after you enter the moon's atmosphere, your communication system springs to life.`
			`	"Unauthorized vessel! Cease thine approach and return to orbit! This world is under crisis jurisdiction of House Kaatrij and no civilian craft are permitted.`
			choice
				`	(Do as they say.)`
					flee
				`	"I'm an ally of House Kaatrij!"`
					to display
						has "successors kaatrij patron"
					goto ally
				`	"I'm not interested in your base, I just want to land elsewhere."`
					goto elsewhere
				`	(Continue anyway.)`

			label proceed
			`	You cut the communication channel and proceed anyway. For a moment, all seems well, but soon your sensors detect weapons fire from emplacements on the surface and the underbelly of your ship is lanced by a barrage of hypervelocity spikes.`
			branch fragile
				has "flagship shields" + "flagship hull" < 25000
			branch medium
				has "flagship shields" + "flagship hull" < 85000
			`	The shots ram against your ship's shields with punishing ferocity, but the <ship> holds fast under the onslaught. However, the heavy fire greatly disturbs your flight path and it becomes increasingly clear that you won't be able to land regardless of your vessel's durability.`
				flee
			label medium
			`	The shots ram against your ship's shields, rapidly wearing them down and disturbing your flight pattern enough that you have no choice but to return to orbit. The batteries stop firing once you clear the atmosphere, fortunately.`
				flee
			label fragile
			`	Your ship's shields go down after the first few shots and it doesn't even take the full volley to destroy your vessel entirely.`
				die

			label ally
			`	"Thou art denied, for thou lack authorization writ. Converse with thy superior if this is in error, and return only when thou can'st present it. Now return to orbit, on pain of death, ally or no."`
			action
				set "successors: ghosts ally referred"
				log "Attempted to land on Qasa-Sija-Iri but was denied for lack of authorization. Instructed to converse with a superior to acquire authorization to land."
			choice
				`	(Return to orbit.)`
					flee
				`	(Continue anyway.)`
					goto proceed

			label elsewhere
			`	"Irrelevant. No civilian vessels are permitted here. Return to orbit, on pain of death."`
			choice
				`	(Return to orbit.)`
					flee
				`	(Continue anyway.)`
					goto proceed

mission "Successors: Ghosts 0a1 QSI Restrict"
	landing
	invisible
	to offer
		has "Successors: Ghosts 0a1 QSI: offered"
	on offer
		event "successors: ghosts restrict"
			decline

mission "Successors: Ghosts 0a2 Authorization"
	priority
	source
		government "House Kaatrij"
	to offer
		has "successors kaatrij patron"
		has "successors: ghosts stage 0"
		not "successors: ghosts restriction lifted"
	on offer
		conversation
			`Though the Kaatrij spaceport is usually quiet, its patrons speaking in hushed whispers, today it is utterly soundless. The very few Successors who go about their business inside do so without a word and stick to only the most filmily-hydrated pathways such that they leave only the most minute of splashes in their wake.`
			`	Near the center of the landing wing is a concierge of sorts; a tall, burnt orange Successor splayed atop a seat of sculpted rocks before a collection of panels.`
			choice
				`	(Go to them.)`
				`	(Go about your business as usual.)`
					decline
			`	As you approach, they push themself off the rocks and into the surrounding puddle. "Hello, noble traveler," they say, "But ask me naught 'bout this House's recent business, for I have naught to give on it."`
			choice
				`	"Can you help me get authorization to approach the moon?"`
				`	"That's okay. Can you help me find Saajret?"`
					goto saajret
			`	The concierge gently rubs a spot on one of the panels, as if trying to remove a stain. "'But ask me naught!' I say, and already my words are as ash and fall unheard. To put it plain, then: no, and never. Make still thy lust for knowledge."`
			choice
				`	"Could you help me find Saajret, then?"`
					goto saajret
				`	"I tried to land there and they told me to seek authorization."`
					to display
						has "successors: ghosts ally referred"
					goto referred
				`	(Leave and go about your business.)`
					decline

			label referred
			`	"That I cannot give," they say, "nor would I do so if empowered."`
			choice
				`	"Could you help me find Saajret, then?"`
					goto saajret
				`	(Leave and go about your business.)`
					decline

			label saajret
			`	The concierge makes a noise like humming, but lower and more musical. "Perhaps. A friend, or companion of yours? But I require more than their third name, traveler."`
			choice
				`	"Saajret, of Somber Sejra."`
					goto "saajret of somber sejra"
				`	"I don't know them by any other names."`
			`	"A rose! A rose," they say, "by any other name would smell as sweet. Not so close a friend, I suppose. But I suppose too much, methinks."`
			choice
				`	"Wait! What about 'Saajret, of Somber Sejra?'"`
					goto "saajret of somber sejra"
				`	(Leave and go about your business.)`
					decline
			
			label "saajret of somber sejra"
			`	"Ah." Their skin shifts to a deep pink, but only for a moment. They pull a long column of metal from the panel in front of them, examining it closely for a time before returning their attention to you. "If thou know'th them well enough to speak of, then 'tis sure thou can'st appreciate the stresses on their time. But," they say, glittering, "I shall notify them of thy desire to meet, and I shall give them thy name and this - " they produce a data-sphere of the sort you've seen the Successors use before " - and if they wish to engage thee, then they may."`
			choice
				`	"My name is <first> <last>."`
					goto end
				`	"Thank you."`
				`	"That's not good enough. I need to speak with them now."`
					goto impatient
			label "who are you"
			`	"Indeed. And what is thy name?"`
			choice
				`	"<first> <last>."`
			label end
			action
				log "Attempted to get in contact with Saajret, of Somber Sejra. Recieved a data-sphere from a House Kaatrij spaceport concierge and was informed that Saajret will make contact on their own time, if at all."
				event "successors: ghosts saajret contact" 9
			`	The concierge rolls the sphere around at the tip of two of their arms for a little while, then proffer it to you. You feel gentle ripples on the surface of the metal, like fingerprints. The concierge then slowly returns to their prior position atop the stone seat, slithering over the wet rocks and draping themself atop them.`
				decline

			label impatient
			`	"Mayhaps, mayhaps. But is thy need echoed by their want, or is it but an arrow pointing to a void?"`
			choice
				`	"Okay, I'm sorry, please just give them my name."`
					goto "who are you"
				`	"Do you ever speak in anything other than riddles?"`
			`	The concierge examines another metallic cylinder projecting from their station. "Today? No." They push the cylinder back and return to their prior position atop the stone seat.`
				decline

mission "Successors: Ghosts 0a3 Saajret"
	landing
	invisible
	source
		attributes "successor"
	to offer
		has "successors: ghosts saajret contact"
	on offer
		conversation
			`Shortly after you land on <origin>, the Successor data-sphere you recieved from the House Kaatrij concierge springs to life. It displays a short message, text-only:`
			`	'Tis good of thee, captain, that thou sought me out upon learning of this recent incident. Thine instincts do thee justice. Nonetheless, I've naught to give thee. The matter underway is of Kaatrij and does not pertain to thee nor the other Houses. If thou well-regards this House, keep clear of this. Enjoy our fruitful world, assist our grateful citizens, be regaled by what gifts we yet may give. Do not pry. This I beseech you, for our sake and for thine: do not be tempted by our secrets' jaws.`
			`	This I myself attest as V- E- Saajret, of Somber Sejra.`
				decline



mission "Successors: Ghosts 0b1 Transport"
	name ""
mission "Successors: Ghosts 0b2 Transport"


mission "Successors: Ghosts 0c Student"
	minor
	name "Return Successor student home"
	description "A Successor student studying on <origin> wants to go home to <destination> after the incident on Qasa-Sija-Iri. Their family will pay you on arrival."
	source "Raaqa-Puan-Uuoru"
	destination "Kasi-Osolaa-Sossa"
	passengers 1
	clearance
	to offer
		has "successors: ghosts stage 0"
	on offer
		conversation
			`In <origin>'s spaceport, you spot a smallish Successor staring wistfully at the list of departures - after the incident on House Kaatrij's moon, flights offworld have been consistently packed. While you're looking, the Successor catches your gaze and glides over to talk to you, taking unusual care to remain within the watery channels that web over the terminal floor.`
			`	"Thou'rt that alien captain, surely," they say, and make a curious grunting noise as they look at you. "Never thought thou were't so... small? No matter. Thou hast a ship, yes? A vessel?"`
			choice
				`	"Yes, I do. A little cramped, but I don't mind it."`
					to display
						and
							has "flagship attribute: bunks" <= 20
							not "outfit (installed): Luxury Accommodations"
					goto cramped
				`	"Yes, I do. It's quite spacious, in fact."`
					to display
						or
							has "flagship attribute: bunks" > 20
							has "outfit (installed): Luxury Accommodations"			
					goto spacious			
				`	"Of course."`
			
			`	The Successor makes a soft noise like humming for a couple of moments. "Fine, fine," they say, "fine. Can'st thou transport me offworld? I must go back home; I can pay upon arrival - surely that interests thee?"`
				goto transportation
			label cramped
			`	"Ugh!" they intone. "Thou must be like an Ejrn in its burrow! Bleh!" They take a moment to compose themself. "Regardless of the... limited dimensions of thy craft, I am forced to ask of thee transportation. Can'st thou provide it? I can pay upon arrival."`
				goto transportation
			label spacious
			`	"We shall see about that," they say, taking a moment to compose themself. "Regardless of my... distaste, I am forced to ask of thee transportation. Can'st thou provide it? I can pay upon arrival."`
			label transportation
			choice
				`	"Sure, where do you need to go?"`
				`	"You'll have to find someone else to take you."`
					goto no
			
			`	"Hm, hm," they say, "<planet>, in the <system> system, if thou'rt unfamiliar. Kaatrij speaks so much of scholarship and learning, but haven't learned enough to even hide their secrets? Better a student at home, I start to think." They pause wistfully before continuing with an "Ugh!" and then "show me to thy ship."`
				accept
			label no
			`	They contort their skin into wrinkles of disgust. "Ugh! Benighted creature! Fine! Go drool over the outfitter or whatever it is thou prefers."`
				decline
	on visit
		dialog "You land on <planet>, but realize that your escort carrying the Successor student hasn't entered the system yet. Better depart and wait for it."
	on complete
		payment 47600
		conversation
			`TODO: End Successors: Ghosts 0c Student`

mission "Successors: Ghosts 1a1a Transport"
	name "Scientist to <destination>"
	destination "Shassa-Wyra-Orrou"
	description "A scientist from House Seineq needs to get to <destination> by <date> to assist their House after the incident on its ally House Kaatrij's moon."
	source
		attributes "successor"
		not government "House Kaatrij"
		not attributes "uninhabited"
	passengers 1
	to offer
		has "successors: ghosts stage 1"
		random < 30

mission "Successors: Ghosts 1a1b Cargo"
	name "Aid supplies to <destination>"
	destination "Shassa-Wyra-Orrou"
	description "<tons> tons of living metal growth plates belonging to House Seineq need to get to <destination> by <date> to assist their ally House Kaatrij after the incident on its moon."
	source
		attributes "successor"
		not government "House Kaatrij"
		not attributes "uninhabited"
	cargo "Living metal plates" 12
	to offer
		has "successors: ghosts stage 1"
		random < 30

mission "Successors: Ghosts 1a1c Mixed"
	name "Engineer to <destination>"
	destination "Shassa-Wyra-Orrou"
	description "An starship engineer from House Seineq and their <tons> tons of equipment need to get to <destination> by <date> to assist their House's ally, House Kaatrij, after the incident on its moon."
	source
		attributes "successor"
		not government "House Kaatrij"
		not attributes "uninhabited"
	passengers 1
	cargo "Repair equipment" 4
	to offer
		has "successors: ghosts stage 1"
		random < 30

mission "Successors: Ghosts 1a2 Sensors"
	source "Shassa-Wyra-Orrou"
	description "House Seineq is concerned that the incident at Qasa-Sija-Iri may be the doing of parties from the other side of the wormhole, and have asked you to deploy a net of sensors in <waypoints>."
	cargo "Successor sensor drones" 6
	to offer
		or
			has "Successors: Ghosts 1a1a Transport: done"
			has "Successors: Ghosts 1a1b Cargo: done"
			has "Successors: Ghosts 1a1c Mixed: done"
	on offer
		conversation
			`It's not long after you return to the spaceport that you are approached by a distinctly stressed-looking Successor who curtly instructs you to follow them to a small side room. You wait there for a minute or two, trying your best to avoid the overhead mist generators, before a pair of Successors enter from the same door you did, and introduce themselves to you.`
			`	"Captain, captain, we lament thy wait. I am Sijra and this," they say, gesturing to the other, "is Rijatet." Rijatet offers a short splay of the arms on hearing their name. "We represent House Seineq here."`
			choice
				`	"How is Seineq connected to all this?"`
				`	"Why are we meeting here?"`
			`	"Our ally, Kaatrij," says Sijra, "has ceased their internal messages to us, and the rest of the New. But even if they do not wish to share, we can derive our own answers well enough."`
			`	"This was an attack," says Rijatet. Their voice is low and rumbly, like rocks rolling down a hill. "Kaatrij would not close up otherwise. They do not trust the other Houses. They never have. They think another House has wounded them."`
			`	"And thou, captain, thou art a... free element. Thy place in this can't be eas'ly divined. We can handle one alien, and their host, but cans't be sure thyself is all we have to reckon with." Waves of color run over Sijra's body, and one of their legs twitches gently against the floor.`
			choice
				`	"Are you saying you think this is some prelude to alien invasion?"`
				`	"Are you saying you think that another House attacked Kaatrij?"`
			`	Sijra wriggles. "No. Not necessarily. Just that we are in need of information and wish to ensure that thou cans't be relied upon to provide it. So," says Sijra, "we have for thee a task. We will load sensors onto thy craft that can be deployed'n the other side of the wormhole, 'round the disconnected stars where our ships can't travel. If this is the work of some meddling alien force thinking cloaks and a jump drive make them gods, then we will know it, and we will show them their folly.`
			choice
				`	"And what if it isn't?"`
					goto isnt
				`	"So you can penetrate cloaks?"`
					goto cloaks
				`	"And what if I refuse?"`
					goto refuse
			label isnt
			`	"Then," Sijra says, "we shall have to determine which of our Houses is threatening war."`
			choice
				`	"Very well, I'll deploy your sensors."`
					goto yes
				`	"I'm not interested in being a part of this."`
					goto refuse
			label cloaks
			`	Pink spots break out over Rijatet's body. "We would not tell thee either way. But never in thirty thousand years have we or our Predecessors met a race with drives like yours that could camouflage their imprint on the weave of space. Listen well enough, and when they jump, it will always be there."`
			choice
				`	"Very well, then, I'll deploy your sensors."`
					goto yes
				`	"I'm not interested in being a part of this."`
					goto refuse
			label refuse
			`	"We won't cage thee, Captain," says Sijra. "Thou art not our vassal, nor our responsibility. But each day of this disruption, thy liability to thy patron - to the Houses all - grows. An alien swims into our pool and soon after, a House is bombed? Thou art an article of suspicion and concern. An opportunity like this will not come again for thee, methinks."`
			choice
				`	"Very well, then, I'll deploy your sensors."`
					goto yes
				`	"I'm still not interested in being part of this."`
			`	Sijra and Rijatet each turn a slightly different shade of blue. "Very well," says Sijra. "Farewell."`
				decline
			label yes
			`	Both of the two seem to relax a bit when you say this, their arms showing a little more slack. Sijra notes down something on a metallic pad that they take out of their outfit, before informing you that they've ordered the sensor drones to be transferred to the <ship>. "Once thy task is done, Captain, return here and we shall have thy next opportunity for usefulness."`
				accept
	on complete
		set "successors: jump drive monitoring"

mission "Successors: Ghosts 1a3 Investigate"
	source "Shassa-Wyra-Orrou"
	description "Investigators from House Seineq want you to report back your dealings with the other High Houses."



# As appropriate, these should be able to offer before 1a3 Investigate
mission "Successors: Ghosts 1b1 Aqrabe" # Mission chain
	on complete
		"successors: ghosts houses dealt with" ++
		set "successors: ghosts dealt with aqrabe"

mission "Successors: Ghosts 1c1 Chydiyi" # Mission chain
	on complete
		"successors: ghosts houses dealt with" ++
		set "successors: ghosts dealt with chydiyi"
		outfit "Rubies" 5

outfit "Rubies"
	plural "Rubies"
	category "Minerals"
	cost 300000
	thumbnail "outfit/unknown"
	"flotsam sprite" "effect/flotsam yottrite"
	"installable" -1
	description "Brilliantly cut gem-quality rubies, blood-red and of uncommon size and vibrance. Though smaller gemstones can be grown without much hassle in the modern era, ones of this size remain both rare and stunning enough to fetch a commanding price in almost any market."

mission "Successors: Ghosts 1d1 Myurej" # Mission chain
	on complete
		"successors: ghosts houses dealt with" ++
		set "successors: ghosts dealt with myurej"

mission "Successors: Ghosts 1d1 Sioeora" # Mission chain
	on complete
		"successors: ghosts houses dealt with" ++
		set "successors: ghosts dealt with sioeora"

mission "Successors: Ghosts 1e1 People's Houses" # Mission chain
	on complete
		"successors: ghosts houses dealt with" ++
		set "successors: ghosts dealt with people's houses"

mission "Successors: Ghosts 1f1 Sieasej" # Mission chain
	on complete
		"successors: ghosts houses dealt with" ++
		set "successors: ghosts dealt with sioeora"

mission "Successors: Ghosts 1g1 Kaatrij" # Mission chain
	on complete
		"successors: ghosts houses dealt with" ++
		set "successors: ghosts dealt with kaatrij"



mission "Successors: Ghosts 1a4 Report"
	to offer
		has "successors: ghosts houses dealt with" >= 3
		or
			has "successors: ghosts dealt with chydiyi"
			has "successors: ghosts dealt with myurej"
			has "successors: ghosts dealt with kaatrij"
	on complete
		payment 1000000

mission "Successors: Ghosts 1a5 Destroyed"
	on offer
		log "The base on Shassa-Wyra-Orrou from which House Seineq organized their investigation has been destroyed, along with the jump drive monitoring equipment."